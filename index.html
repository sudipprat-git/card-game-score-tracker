<!DOCTYPE html>
<html lang="en" class="bg-white text-black dark:bg-gray-900 dark:text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card Game Score Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    /* Custom style to make the first column sticky */
    .sticky-col {
      position: -webkit-sticky;
      position: sticky;
      left: 0;
      z-index: 10;
    }
    .dark .sticky-col {
        background-color: #1f2937; /* Corresponds to dark:bg-gray-800 */
    }
    .sticky-col {
        background-color: #f3f4f6; /* Corresponds to bg-gray-100 */
    }

    tfoot .sticky-col {
        background-color: #e5e7eb; /* Corresponds to bg-gray-200 */
    }

    .dark tfoot .sticky-col {
        background-color: #374151; /* Corresponds to dark:bg-gray-700 */
    }

    thead .sticky-col {
        background-color: #e5e7eb; /* Corresponds to bg-gray-200 */
    }
    .dark thead .sticky-col {
        background-color: #374151; /* Corresponds to dark:bg-gray-700 */
    }
  </style>
</head>
<body class="p-4 max-w-4xl mx-auto">
  <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-3xl font-bold text-center">Card Game Score Tracker</h1>
    <div id="headerActions" class="flex gap-2 hidden">
      <button onclick="editPlayers()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg shadow-md hover:bg-yellow-600 transition-colors">Edit Players</button>
      <button onclick="takeScreenshot()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition-colors">Screenshot</button>
    </div>
  </div>

  <div id="playerInput" class="mb-4 text-center">
    <label for="numPlayers" class="block mb-2 font-semibold">Number of Players:</label>
    <input type="number" id="numPlayers" min="2" max="10" class="border p-2 w-32 rounded-lg" />
    <button onclick="setupPlayers()" class="ml-2 px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors">Next</button>
  </div>

  <div id="nameInput" class="hidden mb-4">
    <h3 class="text-xl font-semibold mb-4 text-center">Enter Player Names</h3>
    <div id="nameFields" class="mb-4 flex flex-col gap-2 items-center"></div>
    <button id="startGameBtn" onclick="createScoreTable()" class="w-full max-w-xs mx-auto block px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">Start Game</button>
  </div>

  <div id="scoreBoard" class="hidden">
    <div class="overflow-x-auto rounded-lg shadow-lg">
      <table class="table-auto border-collapse w-full" id="scoreTable">
        <thead class="sticky top-0 bg-gray-200 dark:bg-gray-700 z-20">
          <tr id="headerRow" class="border-b-2 border-gray-300 dark:border-gray-600">
            <th class="border-r border-gray-300 dark:border-gray-600 px-3 py-2 sticky-col">Round</th>
          </tr>
        </thead>
        <tbody id="scoreBody"></tbody>
        <tfoot class="sticky bottom-0 bg-gray-200 dark:bg-gray-700 z-20">
          <tr id="totalRow" class="border-t-2 border-gray-300 dark:border-gray-600 font-bold">
            <th class="border-r border-gray-300 dark:border-gray-600 px-3 py-2 sticky-col">Total</th>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="mt-6 flex flex-wrap justify-center gap-3">
      <button onclick="addScoreRow()" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors">Add Round</button>
      <button onclick="toggleOldRounds(this)" class="px-4 py-2 bg-purple-500 text-white rounded-lg shadow-md hover:bg-purple-600 transition-colors">Hide Old Rounds</button>
      <button onclick="clearOnlyScores()" class="px-4 py-2 bg-orange-500 text-white rounded-lg shadow-md hover:bg-orange-600 transition-colors">Clear Scores</button>
      <button onclick="endGame()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">End Game & Declare Winner</button>
      <button onclick="clearScores()" class="px-4 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition-colors">Reset Game</button>
    </div>
  </div>

  <div id="winnerModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md text-center transform transition-all scale-95 opacity-0" id="modalContent">
      <h2 class="text-4xl font-bold mb-4">🎉 Game Over! 🎉</h2>
      <div id="winnerList" class="space-y-4 text-left"></div>
      <div class="mt-8 flex gap-4 justify-center">
          <button onclick="closeModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 transition-transform hover:scale-105">Close</button>
          <button onclick="clearScores()" class="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-transform hover:scale-105">Play Again</button>
      </div>
    </div>
  </div>


  <script>
    let playerNames = [];
    let round = 0;
    let showingOldRounds = true;

    function setupPlayers() {
      const numPlayersInput = document.getElementById('numPlayers');
      const numPlayers = parseInt(numPlayersInput.value); // Parse to integer
      if (numPlayers < 2 || numPlayers > 10) {
        alert("Please enter a number of players between 2 and 10.");
        return;
      }

      document.getElementById('playerInput').classList.add('hidden');
      document.getElementById('nameInput').classList.remove('hidden');
      document.getElementById('headerActions').classList.add('hidden'); // Hide buttons

      const nameFields = document.getElementById('nameFields');
      nameFields.innerHTML = ""; // Clear any existing input fields

      for (let i = 0; i < numPlayers; i++) {
        nameFields.innerHTML += `<input type="text" id="player${i}" class="border p-2 mb-1 block w-full max-w-xs rounded-lg dark:bg-gray-800" placeholder="Player ${i + 1} Name">`;
      }
      document.getElementById('startGameBtn').innerText = 'Start Game'; // Ensure button text is "Start Game"
    }

    function createScoreTable() {
      const numPlayers = document.querySelectorAll('#nameFields input').length;
      const newNames = [];

      for (let i = 0; i < numPlayers; i++) {
        const name = document.getElementById(`player${i}`).value.trim();
        if (name === "") {
          alert("Please enter all player names.");
          return;
        }
        newNames.push(name);
      }

      playerNames = newNames;
      document.getElementById('numPlayers').value = playerNames.length;
      document.getElementById('nameInput').classList.add('hidden');
      document.getElementById('scoreBoard').classList.remove('hidden');
      document.getElementById('headerActions').classList.remove('hidden'); // Show buttons

      const headerRow = document.getElementById("headerRow");
      const totalRow = document.getElementById("totalRow");
      headerRow.innerHTML = "<th class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 sticky-col'>Round</th>";
      totalRow.innerHTML = "<th class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 sticky-col'>Total</th>";

      playerNames.forEach((name, index) => {
        headerRow.innerHTML += `<th id="header${index}" class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 bg-gray-100 dark:bg-gray-800 transition-colors'>${name}</th>`;
        totalRow.innerHTML += `<td id="total${index}" class="border-r border-gray-300 dark:border-gray-600 px-3 py-2 font-bold bg-gray-100 dark:bg-gray-800 text-center transition-colors">0</td>`;
      });

      updateTotals();
      saveGame();
    }

    function editPlayers() {
      document.getElementById('scoreBoard').classList.add('hidden');
      document.getElementById('headerActions').classList.add('hidden'); // Hide buttons
      document.getElementById('nameInput').classList.remove('hidden');
      document.getElementById('startGameBtn').innerText = 'Save Changes';


      const nameFields = document.getElementById('nameFields');
      nameFields.innerHTML = "";
      playerNames.forEach((name, i) => {
        nameFields.innerHTML += `<input type="text" id="player${i}" class="border p-2 mb-1 block w-full max-w-xs rounded-lg dark:bg-gray-800" value="${name}" placeholder="Player ${i + 1} Name">`;
      });
    }

    function addScoreRow() {
      round++;
      const tbody = document.getElementById("scoreBody");
      const newRow = document.createElement("tr");
      newRow.id = `round${round}`;
      newRow.className = 'border-b border-gray-200 dark:border-gray-700';
      newRow.innerHTML = `<td class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 font-semibold sticky-col'>${round}</td>`;

      playerNames.forEach((_, index) => {
        newRow.innerHTML += `<td class='border-r border-gray-300 dark:border-gray-600 p-1'><input type="number" value="0" class="w-20 p-1 text-center border rounded-md dark:bg-gray-800" id="score${round}-${index}" oninput="updateTotals()"></td>`;
      });

      tbody.appendChild(newRow);
      if (!showingOldRounds) {
          toggleOldRounds(document.querySelector('[onclick^="toggleOldRounds"]'), true);
      }
      updateTotals();
    }

    function updateTotals() {
      let totals = [];
      const numPlayers = playerNames.length;

      for (let i = 0; i < numPlayers; i++) {
        let total = 0;
        for (let r = 1; r <= round; r++) {
          const scoreInput = document.getElementById(`score${r}-${i}`);
          if (scoreInput) {
            total += parseInt(scoreInput.value) || 0;
          }
        }
        totals.push(total);
        const totalCell = document.getElementById(`total${i}`);
        if (totalCell) {
            totalCell.innerText = total;
        }
      }

      highlightScores(totals);
      saveGame();
      return totals; // Return totals for other functions to use
    }

    function highlightScores(totals) {
        if(totals.length === 0) return;
        
      const maxScore = Math.max(...totals);
      const minScore = Math.min(...totals);

      playerNames.forEach((_, index) => {
        const headerCell = document.getElementById(`header${index}`);
        const totalCell = document.getElementById(`total${index}`);
        headerCell.classList.remove("bg-green-300", "bg-red-300", "dark:bg-green-700", "dark:bg-red-700");
        totalCell.classList.remove("bg-green-300", "bg-red-300", "dark:bg-green-700", "dark:bg-red-700");
        
        if (totals.length > 1 && totals[index] === maxScore) {
          headerCell.classList.add("bg-green-300", "dark:bg-green-700");
          totalCell.classList.add("bg-green-300", "dark:bg-green-700");
        }
        if (totals.length > 1 && totals[index] === minScore) {
          headerCell.classList.add("bg-red-300", "dark:bg-red-700");
          totalCell.classList.add("bg-red-300", "dark:bg-red-700");
        }
      });
    }

    function saveGame() {
      const data = {
        players: playerNames,
        scores: [],
      };
      for (let r = 1; r <= round; r++) {
        const rowScores = [];
        const rowExists = document.getElementById(`round${r}`);
        if(rowExists){
            for (let i = 0; i < playerNames.length; i++) {
              const scoreInput = document.getElementById(`score${r}-${i}`);
              const score = scoreInput ? parseInt(scoreInput.value) || 0 : 0;
              rowScores.push(score);
            }
            data.scores.push(rowScores);
        }
      }
      localStorage.setItem("scoreData", JSON.stringify(data));
    }

    function loadGame() {
      const savedData = localStorage.getItem("scoreData");
      if (!savedData) return;

      const data = JSON.parse(savedData);
      playerNames = data.players || [];
      
      if (playerNames.length === 0) return;
      
      round = 0;
      document.getElementById('numPlayers').value = playerNames.length;
      document.getElementById('playerInput').classList.add('hidden');
      document.getElementById('nameInput').classList.add('hidden');
      document.getElementById('scoreBoard').classList.remove('hidden');
      document.getElementById('headerActions').classList.remove('hidden'); // Show buttons

      const headerRow = document.getElementById("headerRow");
      const totalRow = document.getElementById("totalRow");
      headerRow.innerHTML = "<th class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 sticky-col'>Round</th>";
      totalRow.innerHTML = "<th class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 sticky-col'>Total</th>";

      playerNames.forEach((name, index) => {
        headerRow.innerHTML += `<th id="header${index}" class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 bg-gray-100 dark:bg-gray-800 transition-colors'>${name}</th>`;
        totalRow.innerHTML += `<td id="total${index}" class="border-r border-gray-300 dark:border-gray-600 px-3 py-2 font-bold bg-gray-100 dark:bg-gray-800 text-center transition-colors">0</td>`;
      });

      const tbody = document.getElementById("scoreBody");
      tbody.innerHTML = "";
      data.scores.forEach(rowScores => {
        round++;
        const newRow = document.createElement("tr");
        newRow.id = `round${round}`;
        newRow.className = 'border-b border-gray-200 dark:border-gray-700';
        newRow.innerHTML = `<td class='border-r border-gray-300 dark:border-gray-600 px-3 py-2 font-semibold sticky-col'>${round}</td>`;
        rowScores.forEach((score, idx) => {
          newRow.innerHTML += `<td class='border-r border-gray-300 dark:border-gray-600 p-1'><input type="number" value="${score}" class="w-20 p-1 text-center border rounded-md dark:bg-gray-800" id="score${round}-${idx}" oninput="updateTotals()"></td>`;
        });
        tbody.appendChild(newRow);
      });

      updateTotals();
    }

    function clearScores() {
      if(document.getElementById('winnerModal').classList.contains('hidden')) {
        if (!confirm("Clear all scores and reset the game?")) return;
      }
      closeModal();
      localStorage.removeItem("scoreData");
      location.reload();
    }

    function clearOnlyScores() {
      if (!confirm("Clear all scores and rounds but keep the player names?")) return;
      round = 0;
      document.getElementById("scoreBody").innerHTML = "";
      updateTotals();
    }

    function toggleOldRounds(button, forceUpdate = false) {
        if (!forceUpdate) {
            showingOldRounds = !showingOldRounds;
        }

        for (let r = 1; r <= round; r++) {
            const row = document.getElementById(`round${r}`);
            if (row) {
                if (showingOldRounds || r > round - 3) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            }
        }
        
        if (button) {
            button.innerText = showingOldRounds ? 'Hide Old Rounds' : 'Show All Rounds';
        }
    }


    function takeScreenshot() {
      const scoreBoard = document.getElementById("scoreBoard");
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      const filename = `Scores_${day}-${month}-${year}_${hours}${minutes}.jpeg`;

      html2canvas(scoreBoard, {
        scale: 2
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
      });
    }

    function closeModal() {
      const modal = document.getElementById('winnerModal');
      const modalContent = document.getElementById('modalContent');
      modalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 200); // Match transition duration
    }

    function endGame() {
      const totals = updateTotals();
      const playerData = playerNames.map((name, index) => ({
        name: name,
        score: totals[index]
      })).sort((a, b) => b.score - a.score);

      const winnerList = document.getElementById('winnerList');
      winnerList.innerHTML = ''; // Clear previous results

      const awards = ['🏆', '🥈', '🥉'];
      let lastScore = -Infinity;
      let rank = -1;

      // Show top 3 or more in case of ties
      const playersToShow = playerData.slice(0, 3);
      // Add any player tied with 3rd place
      if (playerData.length > 3 && playerData[2].score === playerData[3].score) {
          for(let i = 3; i < playerData.length; i++) {
              if (playerData[i].score === playerData[2].score) {
                  playersToShow.push(playerData[i]);
              } else {
                  break;
              }
          }
      }
      
      playersToShow.forEach((player, index) => {
        if (player.score < lastScore) {
          rank++;
        }
        if (index === 0) {
            rank = 0;
        }
        lastScore = player.score;

        const award = rank < 3 ? awards[rank] : '🏅';
        
        winnerList.innerHTML += `
          <div class="flex items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
            <span class="text-4xl w-12">${award}</span>
            <div class="flex-grow text-left ml-4">
              <p class="text-xl font-bold">${player.name}</p>
              <p class="text-sm text-gray-600 dark:text-gray-400">${player.score} points</p>
            </div>
          </div>
        `;
      });
      
      const modal = document.getElementById('winnerModal');
      const modalContent = document.getElementById('modalContent');
      modal.classList.remove('hidden');
      setTimeout(() => {
         modalContent.classList.remove('scale-95', 'opacity-0');
      }, 10); // A small delay to allow the display property to apply
    }

    window.onload = loadGame;
  </script>
</body>
</html>